# AI Film Studio - GitLab CI/CD Pipeline with GPU Support
# This pipeline uses GitLab Runner with NVIDIA GPU for AI video generation

stages:
  - build
  - render
  - output
  - cleanup

variables:
  # GPU Configuration
  NVIDIA_VISIBLE_DEVICES: "0"
  NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
  NVIDIA_REQUIRE_CUDA: "cuda>=12.0"
  
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  
  # Video Settings
  VIDEO_PROMPT: "A beautiful sunset over mountains"
  VIDEO_DURATION: "5"
  VIDEO_FPS: "24"
  VIDEO_RESOLUTION: "1280x720"
  VIDEO_GENRE: "cinematic"
  
  # Artifacts
  ARTIFACT_COMPRESSION_LEVEL: "fast"

# Build stage - Prepare environment
build_environment:
  image: nvidia/cuda:12.1-devel-ubuntu22.04
  tags:
    - gpu
    - nvidia
    - cuda
  stage: build
  variables:
    GIT_DEPTH: 1
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq python3 python3-pip git wget ffmpeg
    - pip3 install --upgrade pip
    - pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cu121
    - pip3 install diffusers transformers accelerate opencv-python moviepy
    - nvidia-smi
  script:
    - echo "Building AI Film Studio environment..."
    - python3 --version
    - nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv
    - echo "CUDA Version: $(nvcc --version | grep release | awk '{print $5}')"
  artifacts:
    paths:
      - build_environment/
    expire_in: 1 hour

# Render stage - Generate video using GPU
render_video:
  image: nvidia/cuda:12.1-devel-ubuntu22.04
  tags:
    - gpu
    - nvidia
    - cuda
  stage: render
  script:
    - echo "Starting GPU video generation..."
    - echo "Prompt: $VIDEO_PROMPT"
    - echo "Resolution: $VIDEO_RESOLUTION"
    - echo "Duration: $VIDEO_DURATION seconds"
    - |
      if [ -f "scripts/render_video.py" ]; then
        python3 scripts/render_video.py --prompt "$VIDEO_PROMPT" --duration $VIDEO_DURATION --fps $VIDEO_FPS --resolution $VIDEO_RESOLUTION --output output/video.mp4 --genre $VIDEO_GENRE
      else
        echo "Using fallback video generation..."
        mkdir -p output
        ffmpeg -f lavfi -i color=c=black:s=1280x720:d=5 -vf "drawtext=text='AI Generated Video':fontsize=48:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2" -c:v libx264 output/video.mp4 -y
      fi
    - ls -la output/
    - ffprobe -v quiet -print_format json -show_format -show_streams output/video.mp4 || echo "Video generation completed"
  artifacts:
    paths:
      - output/video.mp4
      - output/thumbnail.jpg
    expire_in: 1 day
  needs:
    - build_environment

# Output stage - Post-process and prepare download
prepare_output:
  image: nvidia/cuda:12.1-devel-ubuntu22.04
  tags:
    - gpu
    - nvidia
    - cuda
  stage: output
  script:
    - echo "Preparing video for download..."
    
    # Generate thumbnail
    - |
      if [ -f "output/video.mp4" ]; then
        ffmpeg -i output/video.mp4 -ss 00:00:02 -vframes 1 -q:v 2 output/thumbnail.jpg -y
        # Create multiple resolutions
        ffmpeg -i output/video.mp4 -vf scale=640:360 -c:v libx264 -crf 23 output/video_360p.mp4 -y
        ffmpeg -i output/video.mp4 -vf scale=1280:720 -c:v libx264 -crf 21 output/video_720p.mp4 -y
      fi
    
    # Create metadata
    - |
      cat > output/metadata.json << EOF
      {
        "prompt": "$VIDEO_PROMPT",
        "duration": $VIDEO_DURATION,
        "fps": $VIDEO_FPS,
        "resolution": "$VIDEO_RESOLUTION",
        "genre": "$VIDEO_GENRE",
        "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
        "gpu": "$(nvidia-smi --query-gpu=name --format=csv,noheader)"
      }
      EOF
    
    - ls -la output/
  artifacts:
    paths:
      - output/
    expire_in: 7 days
  needs:
    - render_video

# Cleanup stage - Clean up temporary files
cleanup:
  image: nvidia/cuda:12.1-devel-ubuntu22.04
  tags:
    - gpu
    - nvidia
    - cuda
  stage: cleanup
  script:
    - echo "Cleaning up temporary files..."
    - rm -rf build/ temp/ *.tmp
    - echo "Cleanup completed"
  when: always

# Manual trigger template for film generation
.generate_film_manual:
  variables:
    VIDEO_PROMPT: "${CUSTOM_PROMPT}"
    VIDEO_DURATION: "${CUSTOM_DURATION:-5}"
    VIDEO_FPS: "${CUSTOM_FPS:-24}"
    VIDEO_RESOLUTION: "${CUSTOM_RESOLUTION:-1280x720}"
    VIDEO_GENRE: "${CUSTOM_GENRE:-cinematic}"
  when: manual
  allow_failure: false

# Example: Generate cinematic trailer
cinematic_trailer:
  extends: [.default_gpu, .generate_film_manual]
  variables:
    VIDEO_PROMPT: "Epic cinematic trailer with dramatic music and visual effects"
    VIDEO_DURATION: "10"
    VIDEO_FPS: "30"
    VIDEO_RESOLUTION: "1920x1080"
    VIDEO_GENRE: "cinematic"
  script:
    - echo "Generating cinematic trailer..."
    - python3 scripts/render_video.py --prompt "$VIDEO_PROMPT" --duration $VIDEO_DURATION --fps $VIDEO_FPS --resolution $VIDEO_RESOLUTION --output output/trailer.mp4 --genre $VIDEO_GENRE
  artifacts:
    paths:
      - output/trailer.mp4
    expire_in: 7 days

# Example: Generate short animation
short_animation:
  extends: [.default_gpu, .generate_film_manual]
  variables:
    VIDEO_PROMPT: "Animated short film with colorful characters"
    VIDEO_DURATION: "15"
    VIDEO_FPS: "24"
    VIDEO_RESOLUTION: "1280x720"
    VIDEO_GENRE: "animation"
  script:
    - echo "Generating animation..."
    - python3 scripts/render_video.py --prompt "$VIDEO_PROMPT" --duration $VIDEO_DURATION --fps $VIDEO_FPS --resolution $VIDEO_RESOLUTION --output output/animation.mp4 --genre $VIDEO_GENRE
  artifacts:
    paths:
      - output/animation.mp4
    expire_in: 7 days
